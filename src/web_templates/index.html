<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - Meme Coin Scanner</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phoenix.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header-section" style="padding: 24px 0 16px 0;">
            <div style="padding-left: 8px;">
                <h1 style="font-size: 4rem; font-weight: 800; color: #ff8c42; margin: 0 0 8px 0; letter-spacing: 2px;">PHNX</h1>
                <div class="user-greeting">Hello, <span>Eamon</span></div>
            </div>
        </header>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-success" id="startBtn" onclick="startScanner()">
                Start Auto Scan
            </button>
            <button class="btn btn-danger" id="stopBtn" onclick="stopScanner()" disabled>
                Stop Scanner
            </button>
            <button class="btn btn-primary" onclick="scanOnce()">
                Scan Once
            </button>
            <button class="btn" onclick="refreshResults()">
                Refresh Results
            </button>
            <span id="statusBadge" class="status-badge status-stopped">STOPPED</span>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">üìä Total Scans</div>
                <div class="stat-value" id="scanCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üéØ Opportunities Found</div>
                <div class="stat-value" id="opportunityCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üî• High Priority</div>
                <div class="stat-value" id="highPriorityCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚è∞ Last Scan</div>
                <div class="stat-value" id="lastScan" style="font-size: 1.2rem;">Never</div>
            </div>
        </div>

        <!-- Progress Section (hidden by default) -->
        <div id="progressSection" class="progress-section" style="display: none;">
            <h3>Scan Progress</h3>
            <div class="phase-indicator">
                <div class="phase-step" id="phase1">1. Discovery</div>
                <div class="phase-step" id="phase2">2. Pre-Filter</div>
                <div class="phase-step" id="phase3">3. Age Check</div>
                <div class="phase-step" id="phase4">4. Security</div>
                <div class="phase-step" id="phase5">5. Revival</div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <p class="progress-message" id="progressMessage">Initializing scan...</p>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed">
            <div class="activity-header">
                <h3>Live Activity</h3>
                <button class="btn" onclick="clearActivity()">Clear</button>
            </div>
            <div class="activity-list" id="activityList">
                <div class="activity-item">
                    <span class="activity-timestamp">--:--:--</span>
                    <span>Waiting for scan to start...</span>
                </div>
            </div>
        </div>

        <!-- Phase Funnel View -->
        <div class="funnel-stats">
            <div class="activity-header">
                <h3>Scanning Pipeline Funnel</h3>
                <button class="btn" onclick="refreshPhases()">Refresh</button>
            </div>
            <div id="phaseFunnel">
                <div class="empty-state">
                    <p>Run a scan to see the token funnel through each phase</p>
                </div>
            </div>
        </div>

        <!-- Download CSV Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="downloadPhase5CSV()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                üì• Download Phase 5 CSV
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #2d3748;">
            <button class="tab-btn active" onclick="switchTab('scanner')" id="scannerTab" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                üîç Scanner Results
            </button>
            <button class="tab-btn" onclick="switchTab('paper')" id="paperTab" style="padding: 12px 24px; background: #2d3748; color: #a0aec0; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                üí∞ Paper Trading
            </button>
        </div>

        <!-- Scanner Results Tab -->
        <div id="scannerTabContent" class="tab-content">
            <div id="resultsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h2>No Results Yet</h2>
                    <p>Click "Scan Once" to start finding revival opportunities!</p>
                </div>
            </div>
        </div>

        <!-- Paper Trading Tab -->
        <div id="paperTabContent" class="tab-content" style="display: none;">
            <!-- Portfolio Summary -->
            <div class="stats" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">üí∞ Total Value</div>
                    <div class="stat-value" id="paperTotalValue">$10,000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üíµ Cash Balance</div>
                    <div class="stat-value" id="paperCash">$10,000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìà Total P&L</div>
                    <div class="stat-value" id="paperPnL">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Open Positions</div>
                    <div class="stat-value" id="paperPositions">0</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="activity-feed" style="margin-bottom: 20px;">
                <div class="activity-header">
                    <h3>Performance Metrics</h3>
                    <button class="btn" onclick="refreshPaperTrading()">Refresh</button>
                </div>
                <div style="padding: 20px; background: #1a202c; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Win Rate:</strong> <span id="winRate">0%</span></div>
                        <div><strong>Total Trades:</strong> <span id="totalTrades">0</span></div>
                        <div><strong>Profit Factor:</strong> <span id="profitFactor">0.00</span></div>
                        <div><strong>Avg Gain:</strong> <span id="avgGain">0%</span></div>
                        <div><strong>Avg Loss:</strong> <span id="avgLoss">0%</span></div>
                        <div><strong>Sharpe Ratio:</strong> <span id="sharpeRatio">0.00</span></div>
                    </div>
                </div>
            </div>

            <!-- Open Positions -->
            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Open Positions</h3>
                    <button class="btn" onclick="loadPaperPositions()">Refresh</button>
                </div>
                <div id="paperPositionsList" style="padding: 20px;">
                    <div class="empty-state">
                        <p>No open positions</p>
                    </div>
                </div>
            </div>

            <!-- Trade History -->
            <div class="activity-feed" style="margin-top: 20px;">
                <div class="activity-header">
                    <h3>Trade History</h3>
                    <button class="btn" onclick="loadPaperTrades()">Refresh</button>
                </div>
                <div id="paperTradesList" style="padding: 20px;">
                    <div class="empty-state">
                        <p>No trades yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefresh = null;
        let activityRefresh = null;

        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        const numberFormatters = {};

        function getNumberFormatter(decimals = 2) {
            if (!numberFormatters[decimals]) {
                numberFormatters[decimals] = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            }
            return numberFormatters[decimals];
        }

        function safeNumber(value, fallback = 0) {
            const num = Number(value);
            return Number.isFinite(num) ? num : fallback;
        }

        function parseTimestamp(value) {
            if (!value) {
                return null;
            }

            let normalized = value.trim();
            if (!/([zZ]|[+-]\d{2}:\d{2})$/.test(normalized)) {
                normalized += 'Z';
            }

            const date = new Date(normalized);
            return Number.isNaN(date.getTime()) ? null : date;
        }

        function formatCurrency(value, decimals = 2) {
            const num = safeNumber(value);
            if (!Number.isFinite(num)) {
                return currencyFormatter.format(0);
            }
            if (decimals !== 2) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(num);
            }
            return currencyFormatter.format(num);
        }

        function formatPercent(value, decimals = 2) {
            const num = safeNumber(value);
            const formatter = getNumberFormatter(decimals);
            return `${formatter.format(num)}%`;
        }

        function formatNumber(value, decimals = 2) {
            const num = safeNumber(value);
            const formatter = getNumberFormatter(decimals);
            return formatter.format(num);
        }

        // Load status on page load
        window.addEventListener('load', () => {
            updateStatus();
            loadResults();
            loadActivity();
            loadPhases();

            // Start polling for activity updates every 2 seconds
            activityRefresh = setInterval(loadActivity, 2000);
        });

        // Update status
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update badge
                const badge = document.getElementById('statusBadge');
                if (data.running) {
                    badge.textContent = 'RUNNING';
                    badge.className = 'status-badge status-running';
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    badge.textContent = 'STOPPED';
                    badge.className = 'status-badge status-stopped';
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }

                // Update stats
                document.getElementById('scanCount').textContent = data.scan_count;

                if (data.last_scan_time) {
                    const lastScan = parseTimestamp(data.last_scan_time);
                    // Convert to Tokyo time (JST - UTC+9)
                    if (lastScan) {
                        document.getElementById('lastScan').textContent = lastScan.toLocaleTimeString('en-US', {
                            timeZone: 'Asia/Tokyo',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }) + ' JST';
                    }
                }

                // Update progress if scan is running
                if (data.current_scan === 'running' && data.progress) {
                    updateProgress(data.progress);
                    document.getElementById('progressSection').style.display = 'block';
                } else if (data.current_scan === 'completed') {
                    document.getElementById('progressSection').style.display = 'none';
                }

            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update progress indicators
        function updateProgress(progress) {
            const phaseNum = progress.phase_number || 0;
            const totalPhases = progress.total_phases || 5;
            const percentage = Math.round((phaseNum / totalPhases) * 100);

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            // Update message
            document.getElementById('progressMessage').textContent = progress.message || 'Processing...';

            // Update phase indicators
            for (let i = 1; i <= 5; i++) {
                const phaseEl = document.getElementById('phase' + i);
                phaseEl.className = 'phase-step';
                if (i < phaseNum) {
                    phaseEl.classList.add('completed');
                } else if (i === phaseNum) {
                    phaseEl.classList.add('active');
                }
            }
        }

        // Load activity feed
        async function loadActivity() {
            try {
                const response = await fetch('/api/activity');
                const data = await response.json();

                if (data.activity && data.activity.length > 0) {
                    displayActivity(data.activity);
                }
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }

        // Display activity
        function displayActivity(activities) {
            const container = document.getElementById('activityList');

            // Only update if there's new content
            const newCount = activities.length;
            const currentCount = container.querySelectorAll('.activity-item').length;

            if (newCount === currentCount && currentCount > 0) {
                return; // No new items
            }

            container.innerHTML = '';

            // Show most recent 50 items
            const recent = activities.slice(-50).reverse();

            recent.forEach(item => {
                const div = document.createElement('div');
                div.className = 'activity-item ' + (item.level || 'info');

                const timestamp = parseTimestamp(item.timestamp);
                // Convert to Tokyo time (JST - UTC+9)
                let timeStr = '--:--:--';
                if (timestamp) {
                    timeStr = timestamp.toLocaleTimeString('en-US', {
                        timeZone: 'Asia/Tokyo',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                }

                div.innerHTML = `
                    <span class="activity-timestamp">${timeStr}</span>
                    <span>${item.message}</span>
                `;

                container.appendChild(div);
            });

            // Auto-scroll to bottom if user was already at bottom
            if (container.scrollHeight - container.scrollTop < container.clientHeight + 100) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // Clear activity
        function clearActivity() {
            document.getElementById('activityList').innerHTML = `
                <div class="activity-item">
                    <span class="activity-timestamp">--:--:--</span>
                    <span>Activity cleared</span>
                </div>
            `;
        }

        // Load results
        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();

                displayResults(data.results);

                // Update counts
                document.getElementById('opportunityCount').textContent = data.filtered;

                const highPriority = data.results.filter(r => r.revival_score >= 0.9).length;
                document.getElementById('highPriorityCount').textContent = highPriority;

            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Display results
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h2>No Results Yet</h2>
                        <p>Click "Scan Once" to start finding revival opportunities!</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="results-grid">
                    ${results.map(token => createTokenCard(token)).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Create token card
        function createTokenCard(token) {
            const score = token.revival_score || 0;
            const priority = score >= 0.9 ? 'high' : (score >= 0.8 ? 'medium' : 'low');
            const priorityLabel = score >= 0.9 ? 'HIGH' : (score >= 0.8 ? 'MEDIUM' : 'LOW');

            // Contract address (shortened)
            const address = token.token_address || '';
            const shortAddress = address ? `${address.slice(0, 4)}...${address.slice(-4)}` : 'N/A';

            return `
                <div class="token-card ${priority}-priority">
                    <div class="token-header">
                        <div>
                            <div class="token-symbol">${token.token_symbol || 'Unknown'}</div>
                            <div class="token-name">${token.token_name || 'Unknown Token'}</div>
                        </div>
                        <span class="priority-badge priority-${priority}">${priorityLabel}</span>
                    </div>

                    <div class="revival-score">
                        <div class="score-label">Revival Score</div>
                        <div class="score-value">${score.toFixed(2)}</div>
                    </div>

                    <!-- Contract Address -->
                    <div class="token-address" onclick="copyToClipboard('${address}')" title="Click to copy">
                        ${shortAddress}
                    </div>

                    <div class="sub-scores">
                        <div class="sub-score">
                            <div class="sub-score-label">Price</div>
                            <div class="sub-score-value">${(token.price_score || 0).toFixed(2)}</div>
                        </div>
                        <div class="sub-score">
                            <div class="sub-score-label">Smart $</div>
                            <div class="sub-score-value">${(token.smart_score || 0).toFixed(2)}</div>
                        </div>
                        <div class="sub-score">
                            <div class="sub-score-label">Volume</div>
                            <div class="sub-score-value">${(token.volume_score || 0).toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="token-metrics">
                        <div class="metric">
                            <div class="metric-label">Age</div>
                            <div class="metric-value">${(token.age_hours || 0).toFixed(1)}h</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Liquidity</div>
                            <div class="metric-value">$${formatNumber(token.liquidity_usd || 0)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Volume 24h</div>
                            <div class="metric-value">$${formatNumber(token.volume_24h || 0)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Price Change</div>
                            <div class="metric-value">${(token.price_change_24h || 0).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div class="token-actions">
                        <a href="${token.dexscreener_url || '#'}" target="_blank" class="action-link">
                            DexScreener
                        </a>
                        ${token.twitter ? `<a href="${token.twitter}" target="_blank" class="action-link">Twitter</a>` : ''}
                        ${token.telegram ? `<a href="${token.telegram}" target="_blank" class="action-link">Telegram</a>` : ''}
                        ${token.website ? `<a href="${token.website}" target="_blank" class="action-link">Website</a>` : ''}
                    </div>
                </div>
            `;
        }

        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Contract address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy address');
            });
        }

        // Format large numbers
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // Start scanner
        async function startScanner() {
            try {
                // First get current settings to show correct interval
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                const scanInterval = statusData.settings?.scan_interval || 3600;

                // Now start the scanner
                const response = await fetch('/api/scan/start', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    // Format interval message
                    const intervalMinutes = Math.floor(scanInterval / 60);
                    const intervalMsg = intervalMinutes >= 60
                        ? `${Math.floor(intervalMinutes / 60)} hour${intervalMinutes >= 120 ? 's' : ''}`
                        : `${intervalMinutes} minute${intervalMinutes > 1 ? 's' : ''}`;
                    alert(`‚úÖ Scanner started! Will scan every ${intervalMsg}.`);
                    updateStatus();

                    // Auto-refresh every 30 seconds
                    if (autoRefresh) clearInterval(autoRefresh);
                    autoRefresh = setInterval(() => {
                        updateStatus();
                        loadResults();
                    }, 30000);
                }
            } catch (error) {
                alert('‚ùå Error starting scanner: ' + error.message);
            }
        }

        // Stop scanner
        async function stopScanner() {
            try {
                const response = await fetch('/api/scan/stop', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    alert('üõë Scanner stopped.');
                    updateStatus();

                    // Stop auto-refresh
                    if (autoRefresh) {
                        clearInterval(autoRefresh);
                        autoRefresh = null;
                    }
                }
            } catch (error) {
                alert('‚ùå Error stopping scanner: ' + error.message);
            }
        }

        // Scan once
        async function scanOnce() {
            try {
                // Show loading and progress section
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Scanning for revival opportunities...</p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Watch the activity feed and progress bar above for real-time updates!</p>
                    </div>
                `;

                // Poll status every second during scan
                const pollInterval = setInterval(() => {
                    updateStatus();
                }, 1000);

                const response = await fetch('/api/scan/once', { method: 'POST' });
                const data = await response.json();

                // Stop polling
                clearInterval(pollInterval);

                if (response.ok) {
                    updateStatus();
                    loadResults();
                    loadPhases();
                } else {
                    alert('‚ùå Scan failed: ' + data.message);
                    loadResults();
                    loadPhases();
                }
            } catch (error) {
                alert('‚ùå Error running scan: ' + error.message);
                loadResults();
            }
        }

        // Refresh results
        function refreshResults() {
            updateStatus();
            loadResults();
        }

        // Download Phase 5 CSV
        function downloadPhase5CSV() {
            // Simply navigate to the download endpoint
            // The browser will automatically download the file
            window.location.href = '/api/download/phase5/latest';
        }

        // Load phase funnel data
        async function loadPhases() {
            try {
                const response = await fetch('/api/phases');
                const data = await response.json();

                if (data.phases && data.phases.length > 0) {
                    displayPhases(data.phases);
                }
            } catch (error) {
                console.error('Error loading phases:', error);
            }
        }

        // Display phase funnel
        function displayPhases(phases) {
            const container = document.getElementById('phaseFunnel');

            if (phases.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <p>No phase data available yet</p>
                    </div>
                `;
                return;
            }

            let html = '';
            let prevCount = 0;

            phases.forEach((phase, idx) => {
                const hasTokens = phase.count > 0;
                const conversionRate = prevCount > 0 ? ((phase.count / prevCount) * 100).toFixed(1) : 100;
                const phaseClass = hasTokens ? 'has-tokens' : 'no-tokens';

                html += `
                    <div class="phase-row ${phaseClass}" onclick="toggleSamples(${phase.phase})" id="phase-row-${phase.phase}">
                        <div class="phase-main">
                            <div class="phase-info">
                                <div class="phase-name">Phase ${phase.phase}: ${phase.name}</div>
                                <div class="phase-description">${phase.description}</div>
                            </div>
                            <div class="phase-stats-info">
                                <div class="token-count">${phase.count.toLocaleString()}</div>
                                ${idx > 0 ? `<div class="conversion-rate">${conversionRate}% conversion</div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="funnel-samples" id="samples-${phase.phase}">
                        ${renderSamples(phase)}
                    </div>
                `;

                prevCount = phase.count;
            });

            container.innerHTML = html;
        }

        // Render sample tokens for a phase
        function renderSamples(phase) {
            if (!phase.samples || phase.samples.length === 0) {
                return '<div style="color: #a0aec0; text-align: center; padding: 20px;">No tokens in this phase</div>';
            }

            let html = '<div style="margin-bottom: 10px; color: #4a5568; font-weight: 600;">Sample Tokens (first 10):</div>';

            phase.samples.forEach(token => {
                let details = [];

                if (token.symbol) {
                    details.push(`<strong>${token.symbol}</strong>`);
                }
                if (token.address) {
                    const shortAddr = token.address.slice(0, 8) + '...' + token.address.slice(-6);
                    details.push(`Address: ${shortAddr}`);
                }
                if (token.liquidity) {
                    details.push(`Liq: $${formatNumber(token.liquidity)}`);
                }
                if (token.volume_24h) {
                    details.push(`Vol 24h: $${formatNumber(token.volume_24h)}`);
                }
                if (token.market_cap) {
                    details.push(`MC: $${formatNumber(token.market_cap)}`);
                }
                if (token.revival_score) {
                    details.push(`Revival Score: ${token.revival_score.toFixed(2)}`);
                }
                if (token.price_score) {
                    details.push(`Price: ${token.price_score.toFixed(2)}`);
                }
                if (token.smart_score) {
                    details.push(`Smart $: ${token.smart_score.toFixed(2)}`);
                }
                if (token.boosts) {
                    details.push(`Boosts: ${token.boosts}`);
                }
                if (token.twitter) {
                    details.push('üê¶ Twitter');
                }
                if (token.telegram) {
                    details.push('üì± Telegram');
                }

                html += `
                    <div class="sample-token">
                        ${details.join(' | ')}
                    </div>
                `;
            });

            return html;
        }

        // Toggle sample display
        function toggleSamples(phaseNum) {
            const samplesDiv = document.getElementById('samples-' + phaseNum);
            if (samplesDiv) {
                samplesDiv.classList.toggle('expanded');
            }
        }

        // Refresh phases
        function refreshPhases() {
            loadPhases();
        }

        // Auto-refresh every minute
        setInterval(updateStatus, 60000);
        setInterval(loadPhases, 30000); // Refresh phases every 30 seconds

        // Auto-refresh paper trading every 2 minutes (when tab is active)
        let paperTradingRefreshInterval = null;

        function startPaperTradingAutoRefresh() {
            if (!paperTradingRefreshInterval) {
                paperTradingRefreshInterval = setInterval(() => {
                    const paperContent = document.getElementById('paperTabContent');
                    if (paperContent && paperContent.style.display !== 'none') {
                        refreshPaperTrading();
                    }
                }, 120000); // 2 minutes
            }
        }

        function stopPaperTradingAutoRefresh() {
            if (paperTradingRefreshInterval) {
                clearInterval(paperTradingRefreshInterval);
                paperTradingRefreshInterval = null;
            }
        }

        // ==================== PAPER TRADING FUNCTIONS ====================

        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            const scannerTab = document.getElementById('scannerTab');
            const paperTab = document.getElementById('paperTab');
            const scannerContent = document.getElementById('scannerTabContent');
            const paperContent = document.getElementById('paperTabContent');

            if (tab === 'scanner') {
                scannerTab.style.background = '#667eea';
                scannerTab.style.color = 'white';
                paperTab.style.background = '#2d3748';
                paperTab.style.color = '#a0aec0';
                scannerContent.style.display = 'block';
                paperContent.style.display = 'none';
                stopPaperTradingAutoRefresh();
            } else {
                scannerTab.style.background = '#2d3748';
                scannerTab.style.color = '#a0aec0';
                paperTab.style.background = '#667eea';
                paperTab.style.color = 'white';
                scannerContent.style.display = 'none';
                paperContent.style.display = 'block';

                // Load paper trading data when tab opens
                refreshPaperTrading();
                startPaperTradingAutoRefresh();
            }
        }

        // Refresh all paper trading data
        async function refreshPaperTrading() {
            await loadPaperPortfolio();
            await loadPaperMetrics();
            await loadPaperPositions();
            await loadPaperTrades();
        }

        // Load portfolio summary
        async function loadPaperPortfolio() {
            try {
                const response = await fetch('/api/paper/portfolio');
                const data = await response.json();

                if (data.status === 'success') {
                    const portfolio = data.portfolio || {};
                    const totalValue = safeNumber(portfolio.total_value_usd);
                    const cashValue = safeNumber(portfolio.cash_usd);
                    const pnlUsd = safeNumber(portfolio.total_pnl_usd);
                    const pnlPct = safeNumber(portfolio.total_pnl_pct);
                    const openPositions = safeNumber(portfolio.open_positions_count, 0);

                    document.getElementById('paperTotalValue').textContent = formatCurrency(totalValue);
                    document.getElementById('paperCash').textContent = formatCurrency(cashValue);

                    const pnlElement = document.getElementById('paperPnL');
                    const pnlPrefix = pnlUsd > 0 ? '+' : '';
                    pnlElement.textContent = `${pnlPrefix}${formatCurrency(pnlUsd)} (${formatPercent(pnlPct)})`;
                    pnlElement.style.color = pnlUsd >= 0 ? '#48bb78' : '#f56565';

                    document.getElementById('paperPositions').textContent = formatNumber(openPositions, 0);
                }
            } catch (error) {
                console.error('Error loading paper portfolio:', error);
            }
        }

        // Load performance metrics
        async function loadPaperMetrics() {
            try {
                const response = await fetch('/api/paper/metrics');
                const data = await response.json();

                if (data.status === 'success') {
                    const metrics = data.metrics;
                    document.getElementById('winRate').textContent = formatPercent(metrics.win_rate || 0, 1);
                    document.getElementById('totalTrades').textContent = formatNumber(metrics.total_trades || 0, 0);
                    document.getElementById('profitFactor').textContent = safeNumber(metrics.profit_factor, 0).toFixed(2);
                    document.getElementById('avgGain').textContent = formatPercent(metrics.avg_gain_pct || 0);
                    document.getElementById('avgLoss').textContent = formatPercent(metrics.avg_loss_pct || 0);
                    document.getElementById('sharpeRatio').textContent = safeNumber(metrics.sharpe_ratio, 0).toFixed(2);
                }
            } catch (error) {
                console.error('Error loading paper metrics:', error);
            }
        }

        // Load open positions
        async function loadPaperPositions() {
            try {
                const response = await fetch('/api/paper/positions');
                const data = await response.json();

                const container = document.getElementById('paperPositionsList');

                if (data.status === 'success' && data.positions.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead style="background: #2d3748;"><tr>';
                    html += '<th style="padding: 10px; text-align: left;">Symbol</th>';
                    html += '<th style="padding: 10px; text-align: right;">Entry</th>';
                    html += '<th style="padding: 10px; text-align: right;">Current</th>';
                    html += '<th style="padding: 10px; text-align: right;">P&L</th>';
                    html += '<th style="padding: 10px; text-align: right;">Size</th>';
                    html += '<th style="padding: 10px; text-align: right;">Remaining</th>';
                    html += '</tr></thead><tbody>';

                    data.positions.forEach(pos => {
                        const entryPrice = safeNumber(pos.entry_price);
                        const currentPrice = safeNumber(pos.current_price);
                        const pnlPct = safeNumber(pos.current_pnl_pct);
                        const sizeUsd = safeNumber(pos.quantity_usd);
                        const remainingPct = safeNumber(pos.remaining_pct);
                        const pnlColor = pnlPct >= 0 ? '#48bb78' : '#f56565';
                        html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                        html += `<td style="padding: 10px;">${pos.symbol}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">$${formatNumber(entryPrice, 8)}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">$${formatNumber(currentPrice, 8)}</td>`;
                        html += `<td style="padding: 10px; text-align: right; color: ${pnlColor};">${formatPercent(pnlPct)}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">${formatCurrency(sizeUsd)}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">${formatNumber(remainingPct, 0)}%</td>`;
                        html += `</tr>`;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>No open positions</p></div>';
                }
            } catch (error) {
                console.error('Error loading paper positions:', error);
            }
        }

        // Track previous trades for flash detection
        let previousTradeIds = new Set();

        // Load trade history
        async function loadPaperTrades() {
            try {
                const response = await fetch('/api/paper/trades?per_page=20');
                const data = await response.json();

                const container = document.getElementById('paperTradesList');

                if (data.status === 'success' && data.trades.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    html += '<thead style="background: #2d3748;"><tr>';
                    html += '<th style="padding: 8px; text-align: left;">Symbol</th>';
                    html += '<th style="padding: 8px; text-align: right;">Entry</th>';
                    html += '<th style="padding: 8px; text-align: right;">Exit</th>';
                    html += '<th style="padding: 8px; text-align: right;">P&L</th>';
                    html += '<th style="padding: 8px; text-align: center;">Exit Type</th>';
                    html += '<th style="padding: 8px; text-align: right;">Hold Time</th>';
                    html += '</tr></thead><tbody>';

                    const newTradeIds = new Set();
                    data.trades.forEach(trade => {
                        const entryPrice = safeNumber(trade.entry_price);
                        const exitPrice = safeNumber(trade.exit_price);
                        const pnlPct = safeNumber(trade.pnl_pct);
                        const pnlColor = pnlPct >= 0 ? '#48bb78' : '#f56565';
                        newTradeIds.add(trade.id);

                        // Check if this is a new trade (not in previous load)
                        const isNewTrade = !previousTradeIds.has(trade.id);
                        let flashClass = '';
                        if (isNewTrade && trade.pnl_pct >= 0) {
                            flashClass = ' flash-profit';
                        } else if (isNewTrade && trade.pnl_pct < 0) {
                            flashClass = ' flash-loss';
                        }

                        // Determine badge class based on exit type
                        let badgeClass = 'exit-badge';
                        if (trade.exit_type.includes('stop_loss')) {
                            badgeClass += ' stop-loss';
                        } else if (trade.exit_type.includes('take_profit')) {
                            badgeClass += ' take-profit';
                        } else if (trade.exit_type === 'failed_exit') {
                            badgeClass += ' failed';
                        } else if (trade.exit_type === 'max_hold') {
                            badgeClass += ' expired';
                        }

                        html += `<tr class="${flashClass}" style="border-bottom: 1px solid #2d3748;">`;
                        html += `<td style="padding: 8px;">${trade.symbol}</td>`;
                        html += `<td style="padding: 8px; text-align: right;">$${formatNumber(entryPrice, 8)}</td>`;
                        html += `<td style="padding: 8px; text-align: right;">$${formatNumber(exitPrice, 8)}</td>`;
                        html += `<td style="padding: 8px; text-align: right; color: ${pnlColor};">${formatPercent(pnlPct)}</td>`;
                        html += `<td style="padding: 8px; text-align: center;"><span class="${badgeClass}">${trade.exit_type.replace(/_/g, ' ')}</span></td>`;
                        html += `<td style="padding: 8px; text-align: right;">${parseFloat(trade.hold_days).toFixed(1)}d</td>`;
                        html += `</tr>`;
                    });

                    // Update previous trade IDs for next comparison
                    previousTradeIds = newTradeIds;

                    html += '</tbody></table>';
                    html += `<div style="margin-top: 10px; color: #a0aec0;">Showing ${data.trades.length} of ${data.count} trades</div>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>No trades yet</p></div>';
                }
            } catch (error) {
                console.error('Error loading paper trades:', error);
            }
        }
    </script>
</body>
</html>