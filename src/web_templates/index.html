<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - Meme Coin Scanner</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phoenix.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header-section" style="padding: 24px 0 16px 0;">
            <div style="padding-left: 8px;">
                <h1 style="font-size: 4rem; font-weight: 800; color: #ff8c42; margin: 0 0 8px 0; letter-spacing: 2px;">PHNX</h1>
                <div class="user-greeting">Hello, <span>Eamon</span></div>
            </div>
        </header>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-success" id="startBtn" onclick="startScanner()">
                Start Auto Scan
            </button>
            <button class="btn btn-danger" id="stopBtn" onclick="stopScanner()" disabled>
                Stop Scanner
            </button>
            <button class="btn btn-primary" onclick="scanOnce()">
                Scan Once
            </button>
            <button class="btn" onclick="refreshResults()">
                Refresh Results
            </button>
            <span id="statusBadge" class="status-badge status-stopped">STOPPED</span>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">üìä Total Scans</div>
                <div class="stat-value" id="scanCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üéØ Opportunities Found</div>
                <div class="stat-value" id="opportunityCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üî• High Priority</div>
                <div class="stat-value" id="highPriorityCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚è∞ Last Scan</div>
                <div class="stat-value" id="lastScan" style="font-size: 1.2rem;">Never</div>
            </div>
        </div>

        <!-- Progress Section (hidden by default) -->
        <div id="progressSection" class="progress-section" style="display: none;">
            <h3>Scan Progress</h3>
            <div class="phase-indicator">
                <div class="phase-step" id="phase1">1. Discovery</div>
                <div class="phase-step" id="phase2">2. Pre-Filter</div>
                <div class="phase-step" id="phase3">3. Age Check</div>
                <div class="phase-step" id="phase4">4. Security</div>
                <div class="phase-step" id="phase5">5. Revival</div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <p class="progress-message" id="progressMessage">Initializing scan...</p>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed">
            <div class="activity-header">
                <h3>Live Activity</h3>
                <button class="btn" onclick="clearActivity()">Clear</button>
            </div>
            <div class="activity-list" id="activityList">
                <div class="activity-item">
                    <span class="activity-timestamp">--:--:--</span>
                    <span>Waiting for scan to start...</span>
                </div>
            </div>
        </div>

        <!-- Phase Funnel View -->
        <div class="funnel-stats">
            <div class="activity-header">
                <h3>Scanning Pipeline Funnel</h3>
                <button class="btn" onclick="refreshPhases()">Refresh</button>
            </div>
            <div id="phaseFunnel">
                <div class="empty-state">
                    <p>Run a scan to see the token funnel through each phase</p>
                </div>
            </div>
        </div>

        <!-- Download CSV Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="downloadPhase5CSV()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                üì• Download Phase 5 CSV
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #2d3748;">
            <button class="tab-btn active" onclick="switchTab('scanner')" id="scannerTab" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                üîç Scanner Results
            </button>
            <button class="tab-btn" onclick="switchTab('paper')" id="paperTab" style="padding: 12px 24px; background: #2d3748; color: #a0aec0; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                üí∞ Paper Trading
            </button>
            <button class="tab-btn" onclick="switchTab('analytics')" id="analyticsTab" style="padding: 12px 24px; background: #2d3748; color: #a0aec0; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                üìä Analytics
            </button>
        </div>

        <!-- Scanner Results Tab -->
        <div id="scannerTabContent" class="tab-content">
            <div id="resultsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h2>No Results Yet</h2>
                    <p>Click "Scan Once" to start finding revival opportunities!</p>
                </div>
            </div>
        </div>

        <!-- Paper Trading Tab -->
        <div id="paperTabContent" class="tab-content" style="display: none;">
            <!-- Portfolio Summary -->
            <div class="stats" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">üí∞ Total Value</div>
                    <div class="stat-value" id="paperTotalValue">$10,000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üíµ Cash Balance</div>
                    <div class="stat-value" id="paperCash">$10,000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìà Total P&L</div>
                    <div class="stat-value" id="paperPnL">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Open Positions</div>
                    <div class="stat-value" id="paperPositions">0</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="activity-feed" style="margin-bottom: 20px;">
                <div class="activity-header">
                    <h3>Performance Metrics</h3>
                    <button class="btn" onclick="refreshPaperTrading()">Refresh</button>
                </div>
                <div style="padding: 20px; background: #1a202c; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Win Rate:</strong> <span id="winRate">0%</span></div>
                        <div><strong>Total Trades:</strong> <span id="totalTrades">0</span></div>
                        <div><strong>Profit Factor:</strong> <span id="profitFactor">0.00</span></div>
                        <div><strong>Avg Gain:</strong> <span id="avgGain">0%</span></div>
                        <div><strong>Avg Loss:</strong> <span id="avgLoss">0%</span></div>
                        <div><strong>Sharpe Ratio:</strong> <span id="sharpeRatio">0.00</span></div>
                    </div>
                </div>
            </div>

            <!-- Open Positions -->
            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Open Positions</h3>
                    <button class="btn" onclick="loadPaperPositions()">Refresh</button>
                </div>
                <div id="paperPositionsList" style="padding: 20px;">
                    <div class="empty-state">
                        <p>No open positions</p>
                    </div>
                </div>
            </div>

            <!-- Trade History -->
            <div class="activity-feed" style="margin-top: 20px;">
                <div class="activity-header">
                    <h3>Trade History</h3>
                    <button class="btn" onclick="loadPaperTrades()">Refresh</button>
                </div>
                <div id="paperTradesList" style="padding: 20px;">
                    <div class="empty-state">
                        <p>No trades yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTabContent" class="tab-content" style="display: none;">
            <div class="stats" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Return %</div>
                    <div class="stat-value" id="analyticsReturnPct">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Absolute PnL</div>
                    <div class="stat-value" id="analyticsAbsPnl">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Drawdown</div>
                    <div class="stat-value" id="analyticsDrawdown">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Trades (Buy/Sell)</div>
                    <div class="stat-value" id="analyticsTrades">--</div>
                </div>
            </div>

            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Portfolio Value (Rolling)</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="loadAnalyticsOverview()">Refresh</button>
                        <button class="btn btn-primary" onclick="triggerAnalyticsReport('daily')">Run Daily Report</button>
                        <button class="btn btn-primary" onclick="triggerAnalyticsReport('weekly')">Run Weekly Report</button>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <canvas id="analyticsPerformanceChart" height="160"></canvas>
                    <p style="margin-top: 12px; color: #a0aec0;" id="analyticsPeriodLabel"></p>
                </div>
            </div>

            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Top Token Flows</h3>
                    <button class="btn" onclick="loadAnalyticsOverview()">Refresh</button>
                </div>
                <div id="analyticsTokenFlows" style="padding: 20px;">
                    <div class="empty-state"><p>Enable analytics to view token flow breakdowns.</p></div>
                </div>
            </div>

            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Recent Trades</h3>
                    <button class="btn" onclick="loadAnalyticsOverview()">Refresh</button>
                </div>
                <div id="analyticsRecentTrades" style="padding: 20px;">
                    <div class="empty-state"><p>No trades recorded in the selected window.</p></div>
                </div>
            </div>

            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Daily Summary</h3>
                    <button class="btn" onclick="triggerAnalyticsReport('daily')">Regenerate</button>
                </div>
                <div id="analyticsDailySummary" style="padding: 20px;">
                    <div class="empty-state"><p>No daily summary yet.</p></div>
                </div>
            </div>

            <div class="activity-feed">
                <div class="activity-header">
                    <h3>Weekly Summary</h3>
                    <button class="btn" onclick="triggerAnalyticsReport('weekly')">Regenerate</button>
                </div>
                <div id="analyticsWeeklySummary" style="padding: 20px;">
                    <div class="empty-state"><p>No weekly summary yet.</p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefresh = null;
        let activityRefresh = null;
        let analyticsChart = null;

        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        const numberFormatters = {};

        function getNumberFormatter(decimals = 2) {
            if (!numberFormatters[decimals]) {
                numberFormatters[decimals] = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            }
            return numberFormatters[decimals];
        }

        function safeNumber(value, fallback = 0) {
            const num = Number(value);
            return Number.isFinite(num) ? num : fallback;
        }

        function toFiniteNumber(value) {
            if (value === null || value === undefined || value === '') {
                return null;
            }
            const num = Number(value);
            return Number.isFinite(num) ? num : null;
        }

        function parseTimestamp(value) {
            if (!value) {
                return null;
            }

            let normalized = value.trim();
            if (!/([zZ]|[+-]\d{2}:\d{2})$/.test(normalized)) {
                normalized += 'Z';
            }

            const date = new Date(normalized);
            return Number.isNaN(date.getTime()) ? null : date;
        }

        function formatCurrency(value, decimals = 2) {
            const num = safeNumber(value);
            if (!Number.isFinite(num)) {
                return currencyFormatter.format(0);
            }
            if (decimals !== 2) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(num);
            }
            return currencyFormatter.format(num);
        }

        function formatPercent(value, decimals = 2) {
            const num = safeNumber(value);
            const formatter = getNumberFormatter(decimals);
            return `${formatter.format(num)}%`;
        }

        function formatTokenPrice(value) {
            const num = safeNumber(value);
            if (!Number.isFinite(num)) {
                return '$0.00';
            }

            if (num === 0) {
                return '$0.00';
            }

            const absVal = Math.abs(num);
            let decimals;
            if (absVal >= 1) {
                decimals = 4;
            } else if (absVal >= 0.01) {
                decimals = 6;
            } else if (absVal >= 0.0001) {
                decimals = 8;
            } else {
                decimals = 10;
            }

            return '$' + formatNumber(num, decimals);
        }

        function formatNumber(value, decimals = 2) {
            const num = safeNumber(value);
            const formatter = getNumberFormatter(decimals);
            return formatter.format(num);
        }

        // Load status on page load
        window.addEventListener('load', () => {
            updateStatus();
            loadResults();
            loadActivity();
            loadPhases();

            // Start polling for activity updates every 2 seconds
            activityRefresh = setInterval(loadActivity, 2000);
        });

        // Update status
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update badge
                const badge = document.getElementById('statusBadge');
                if (data.running) {
                    badge.textContent = 'RUNNING';
                    badge.className = 'status-badge status-running';
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    badge.textContent = 'STOPPED';
                    badge.className = 'status-badge status-stopped';
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }

                // Update stats
                document.getElementById('scanCount').textContent = data.scan_count;

                if (data.last_scan_time) {
                    const lastScan = parseTimestamp(data.last_scan_time);
                    // Convert to Tokyo time (JST - UTC+9)
                    if (lastScan) {
                        document.getElementById('lastScan').textContent = lastScan.toLocaleTimeString('en-US', {
                            timeZone: 'Asia/Tokyo',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }) + ' JST';
                    }
                }

                // Update progress if scan is running
                if (data.current_scan === 'running' && data.progress) {
                    updateProgress(data.progress);
                    document.getElementById('progressSection').style.display = 'block';
                } else if (data.current_scan === 'completed') {
                    document.getElementById('progressSection').style.display = 'none';
                }

            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update progress indicators
        function updateProgress(progress) {
            const phaseNum = progress.phase_number || 0;
            const totalPhases = progress.total_phases || 5;
            const percentage = Math.round((phaseNum / totalPhases) * 100);

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            // Update message
            document.getElementById('progressMessage').textContent = progress.message || 'Processing...';

            // Update phase indicators
            for (let i = 1; i <= 5; i++) {
                const phaseEl = document.getElementById('phase' + i);
                phaseEl.className = 'phase-step';
                if (i < phaseNum) {
                    phaseEl.classList.add('completed');
                } else if (i === phaseNum) {
                    phaseEl.classList.add('active');
                }
            }
        }

        // Load activity feed
        async function loadActivity() {
            try {
                const response = await fetch('/api/activity');
                const data = await response.json();

                if (data.activity && data.activity.length > 0) {
                    displayActivity(data.activity);
                }
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }

        // Display activity
        function displayActivity(activities) {
            const container = document.getElementById('activityList');

            // Only update if there's new content
            const newCount = activities.length;
            const currentCount = container.querySelectorAll('.activity-item').length;

            if (newCount === currentCount && currentCount > 0) {
                return; // No new items
            }

            container.innerHTML = '';

            // Show most recent 50 items
            const recent = activities.slice(-50).reverse();

            recent.forEach(item => {
                const div = document.createElement('div');
                div.className = 'activity-item ' + (item.level || 'info');

                const timestamp = parseTimestamp(item.timestamp);
                // Convert to Tokyo time (JST - UTC+9)
                let timeStr = '--:--:--';
                if (timestamp) {
                    timeStr = timestamp.toLocaleTimeString('en-US', {
                        timeZone: 'Asia/Tokyo',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                }

                div.innerHTML = `
                    <span class="activity-timestamp">${timeStr}</span>
                    <span>${item.message}</span>
                `;

                container.appendChild(div);
            });

            // Auto-scroll to bottom if user was already at bottom
            if (container.scrollHeight - container.scrollTop < container.clientHeight + 100) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // Clear activity
        function clearActivity() {
            document.getElementById('activityList').innerHTML = `
                <div class="activity-item">
                    <span class="activity-timestamp">--:--:--</span>
                    <span>Activity cleared</span>
                </div>
            `;
        }

        // Load results
        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();

                displayResults(data.results);

                // Update counts
                document.getElementById('opportunityCount').textContent = data.filtered;

                const highPriority = data.results.filter(r => r.revival_score >= 0.9).length;
                document.getElementById('highPriorityCount').textContent = highPriority;

            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Display results
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h2>No Results Yet</h2>
                        <p>Click "Scan Once" to start finding revival opportunities!</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="results-grid">
                    ${results.map(token => createTokenCard(token)).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Create token card
        function createTokenCard(token) {
            const score = token.revival_score || 0;
            const priority = score >= 0.9 ? 'high' : (score >= 0.8 ? 'medium' : 'low');
            const priorityLabel = score >= 0.9 ? 'HIGH' : (score >= 0.8 ? 'MEDIUM' : 'LOW');

            // Contract address (shortened)
            const address = token.token_address || '';
            const shortAddress = address ? `${address.slice(0, 4)}...${address.slice(-4)}` : 'N/A';

            return `
                <div class="token-card ${priority}-priority">
                    <div class="token-header">
                        <div>
                            <div class="token-symbol">${token.token_symbol || 'Unknown'}</div>
                            <div class="token-name">${token.token_name || 'Unknown Token'}</div>
                        </div>
                        <span class="priority-badge priority-${priority}">${priorityLabel}</span>
                    </div>

                    <div class="revival-score">
                        <div class="score-label">Revival Score</div>
                        <div class="score-value">${score.toFixed(2)}</div>
                    </div>

                    <!-- Contract Address -->
                    <div class="token-address" onclick="copyToClipboard('${address}')" title="Click to copy">
                        ${shortAddress}
                    </div>

                    <div class="sub-scores">
                        <div class="sub-score">
                            <div class="sub-score-label">Price</div>
                            <div class="sub-score-value">${(token.price_score || 0).toFixed(2)}</div>
                        </div>
                        <div class="sub-score">
                            <div class="sub-score-label">Smart $</div>
                            <div class="sub-score-value">${(token.smart_score || 0).toFixed(2)}</div>
                        </div>
                        <div class="sub-score">
                            <div class="sub-score-label">Volume</div>
                            <div class="sub-score-value">${(token.volume_score || 0).toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="token-metrics">
                        <div class="metric">
                            <div class="metric-label">Age</div>
                            <div class="metric-value">${(token.age_hours || 0).toFixed(1)}h</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Liquidity</div>
                            <div class="metric-value">$${formatNumber(token.liquidity_usd || 0)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Volume 24h</div>
                            <div class="metric-value">$${formatNumber(token.volume_24h || 0)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Price Change</div>
                            <div class="metric-value">${(token.price_change_24h || 0).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div class="token-actions">
                        <a href="${token.dexscreener_url || '#'}" target="_blank" class="action-link">
                            DexScreener
                        </a>
                        ${token.twitter ? `<a href="${token.twitter}" target="_blank" class="action-link">Twitter</a>` : ''}
                        ${token.telegram ? `<a href="${token.telegram}" target="_blank" class="action-link">Telegram</a>` : ''}
                        ${token.website ? `<a href="${token.website}" target="_blank" class="action-link">Website</a>` : ''}
                    </div>
                </div>
            `;
        }

        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Contract address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy address');
            });
        }

        // Format large numbers
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // Start scanner
        async function startScanner() {
            try {
                // First get current settings to show correct interval
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                const scanInterval = statusData.settings?.scan_interval || 3600;

                // Now start the scanner
                const response = await fetch('/api/scan/start', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    // Format interval message
                    const intervalMinutes = Math.floor(scanInterval / 60);
                    const intervalMsg = intervalMinutes >= 60
                        ? `${Math.floor(intervalMinutes / 60)} hour${intervalMinutes >= 120 ? 's' : ''}`
                        : `${intervalMinutes} minute${intervalMinutes > 1 ? 's' : ''}`;
                    alert(`‚úÖ Scanner started! Will scan every ${intervalMsg}.`);
                    updateStatus();

                    // Auto-refresh every 30 seconds
                    if (autoRefresh) clearInterval(autoRefresh);
                    autoRefresh = setInterval(() => {
                        updateStatus();
                        loadResults();
                    }, 30000);
                }
            } catch (error) {
                alert('‚ùå Error starting scanner: ' + error.message);
            }
        }

        // Stop scanner
        async function stopScanner() {
            try {
                const response = await fetch('/api/scan/stop', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    alert('üõë Scanner stopped.');
                    updateStatus();

                    // Stop auto-refresh
                    if (autoRefresh) {
                        clearInterval(autoRefresh);
                        autoRefresh = null;
                    }
                }
            } catch (error) {
                alert('‚ùå Error stopping scanner: ' + error.message);
            }
        }

        // Scan once
        async function scanOnce() {
            try {
                // Show loading and progress section
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Scanning for revival opportunities...</p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Watch the activity feed and progress bar above for real-time updates!</p>
                    </div>
                `;

                // Poll status every second during scan
                const pollInterval = setInterval(() => {
                    updateStatus();
                }, 1000);

                const response = await fetch('/api/scan/once', { method: 'POST' });
                const data = await response.json();

                // Stop polling
                clearInterval(pollInterval);

                if (response.ok) {
                    updateStatus();
                    loadResults();
                    loadPhases();
                } else {
                    alert('‚ùå Scan failed: ' + data.message);
                    loadResults();
                    loadPhases();
                }
            } catch (error) {
                alert('‚ùå Error running scan: ' + error.message);
                loadResults();
            }
        }

        // Refresh results
        function refreshResults() {
            updateStatus();
            loadResults();
        }

        // Download Phase 5 CSV
        function downloadPhase5CSV() {
            // Simply navigate to the download endpoint
            // The browser will automatically download the file
            window.location.href = '/api/download/phase5/latest';
        }

        // Load phase funnel data
        async function loadPhases() {
            try {
                const response = await fetch('/api/phases');
                const data = await response.json();

                if (data.phases && data.phases.length > 0) {
                    displayPhases(data.phases);
                }
            } catch (error) {
                console.error('Error loading phases:', error);
            }
        }

        // Display phase funnel
        function displayPhases(phases) {
            const container = document.getElementById('phaseFunnel');

            if (phases.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <p>No phase data available yet</p>
                    </div>
                `;
                return;
            }

            let html = '';
            let prevCount = 0;

            phases.forEach((phase, idx) => {
                const hasTokens = phase.count > 0;
                const conversionRate = prevCount > 0 ? ((phase.count / prevCount) * 100).toFixed(1) : 100;
                const phaseClass = hasTokens ? 'has-tokens' : 'no-tokens';

                html += `
                    <div class="phase-row ${phaseClass}" onclick="toggleSamples(${phase.phase})" id="phase-row-${phase.phase}">
                        <div class="phase-main">
                            <div class="phase-info">
                                <div class="phase-name">Phase ${phase.phase}: ${phase.name}</div>
                                <div class="phase-description">${phase.description}</div>
                            </div>
                            <div class="phase-stats-info">
                                <div class="token-count">${phase.count.toLocaleString()}</div>
                                ${idx > 0 ? `<div class="conversion-rate">${conversionRate}% conversion</div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="funnel-samples" id="samples-${phase.phase}">
                        ${renderSamples(phase)}
                    </div>
                `;

                prevCount = phase.count;
            });

            container.innerHTML = html;
        }

        // Render sample tokens for a phase
        function renderSamples(phase) {
            if (!phase.samples || phase.samples.length === 0) {
                return '<div style="color: #a0aec0; text-align: center; padding: 20px;">No tokens in this phase</div>';
            }

            let html = '<div style="margin-bottom: 10px; color: #4a5568; font-weight: 600;">Sample Tokens (first 10):</div>';

            phase.samples.forEach(token => {
                let details = [];

                if (token.symbol) {
                    details.push(`<strong>${token.symbol}</strong>`);
                }
                if (token.address) {
                    const shortAddr = token.address.slice(0, 8) + '...' + token.address.slice(-6);
                    details.push(`Address: ${shortAddr}`);
                }
                if (token.liquidity) {
                    details.push(`Liq: $${formatNumber(token.liquidity)}`);
                }
                if (token.volume_24h) {
                    details.push(`Vol 24h: $${formatNumber(token.volume_24h)}`);
                }
                if (token.market_cap) {
                    details.push(`MC: $${formatNumber(token.market_cap)}`);
                }
                if (token.revival_score) {
                    details.push(`Revival Score: ${token.revival_score.toFixed(2)}`);
                }
                if (token.price_score) {
                    details.push(`Price: ${token.price_score.toFixed(2)}`);
                }
                if (token.smart_score) {
                    details.push(`Smart $: ${token.smart_score.toFixed(2)}`);
                }
                if (token.boosts) {
                    details.push(`Boosts: ${token.boosts}`);
                }
                if (token.twitter) {
                    details.push('üê¶ Twitter');
                }
                if (token.telegram) {
                    details.push('üì± Telegram');
                }

                html += `
                    <div class="sample-token">
                        ${details.join(' | ')}
                    </div>
                `;
            });

            return html;
        }

        // Toggle sample display
        function toggleSamples(phaseNum) {
            const samplesDiv = document.getElementById('samples-' + phaseNum);
            if (samplesDiv) {
                samplesDiv.classList.toggle('expanded');
            }
        }

        // Refresh phases
        function refreshPhases() {
            loadPhases();
        }

        // Auto-refresh every minute
        setInterval(updateStatus, 60000);
        setInterval(loadPhases, 30000); // Refresh phases every 30 seconds

        // Auto-refresh paper trading every 2 minutes (when tab is active)
        let paperTradingRefreshInterval = null;
        let analyticsRefreshInterval = null;

        function startPaperTradingAutoRefresh() {
            if (!paperTradingRefreshInterval) {
                paperTradingRefreshInterval = setInterval(() => {
                    const paperContent = document.getElementById('paperTabContent');
                    if (paperContent && paperContent.style.display !== 'none') {
                        refreshPaperTrading();
                    }
                }, 60000); // 1 minute
            }
        }

        function stopPaperTradingAutoRefresh() {
            if (paperTradingRefreshInterval) {
                clearInterval(paperTradingRefreshInterval);
                paperTradingRefreshInterval = null;
            }
        }

        function startAnalyticsAutoRefresh() {
            if (!analyticsRefreshInterval) {
                analyticsRefreshInterval = setInterval(() => {
                    const analyticsContent = document.getElementById('analyticsTabContent');
                    if (analyticsContent && analyticsContent.style.display !== 'none') {
                        loadAnalyticsOverview();
                    }
                }, 180000); // 3 minutes
            }
        }

        function stopAnalyticsAutoRefresh() {
            if (analyticsRefreshInterval) {
                clearInterval(analyticsRefreshInterval);
                analyticsRefreshInterval = null;
            }
        }

        // ==================== PAPER TRADING FUNCTIONS ====================

        // Switch tabs
        function switchTab(tab) {
            const tabs = [
                { key: 'scanner', button: document.getElementById('scannerTab'), content: document.getElementById('scannerTabContent') },
                { key: 'paper', button: document.getElementById('paperTab'), content: document.getElementById('paperTabContent') },
                { key: 'analytics', button: document.getElementById('analyticsTab'), content: document.getElementById('analyticsTabContent') }
            ];

            tabs.forEach(({ key, button, content }) => {
                if (!button || !content) return;
                const isActive = key === tab;
                button.style.background = isActive ? '#667eea' : '#2d3748';
                button.style.color = isActive ? 'white' : '#a0aec0';
                content.style.display = isActive ? 'block' : 'none';
            });

            if (tab === 'paper') {
                refreshPaperTrading();
                startPaperTradingAutoRefresh();
                stopAnalyticsAutoRefresh();
            } else if (tab === 'analytics') {
                loadAnalyticsOverview();
                startAnalyticsAutoRefresh();
                stopPaperTradingAutoRefresh();
            } else {
                stopPaperTradingAutoRefresh();
                stopAnalyticsAutoRefresh();
            }
        }

        // Refresh all paper trading data
        async function refreshPaperTrading() {
            await loadPaperPortfolio();
            await loadPaperMetrics();
            await loadPaperPositions();
            await loadPaperTrades();
        }

        // Load portfolio summary
        async function loadPaperPortfolio() {
            try {
                const response = await fetch('/api/paper/portfolio');
                const data = await response.json();

                if (data.status === 'success') {
                    const portfolio = data.portfolio || {};
                    const totalValue = safeNumber(portfolio.total_value_usd);
                    const cashValue = safeNumber(portfolio.cash_usd);
                    const pnlUsd = safeNumber(portfolio.total_pnl_usd);
                    const pnlPct = safeNumber(portfolio.total_pnl_pct);
                    const openPositions = safeNumber(portfolio.open_positions_count, 0);

                    document.getElementById('paperTotalValue').textContent = formatCurrency(totalValue);
                    document.getElementById('paperCash').textContent = formatCurrency(cashValue);

                    const pnlElement = document.getElementById('paperPnL');
                    const pnlPrefix = pnlUsd > 0 ? '+' : '';
                    pnlElement.textContent = `${pnlPrefix}${formatCurrency(pnlUsd)} (${formatPercent(pnlPct)})`;
                    pnlElement.style.color = pnlUsd >= 0 ? '#48bb78' : '#f56565';

                    document.getElementById('paperPositions').textContent = formatNumber(openPositions, 0);
                }
            } catch (error) {
                console.error('Error loading paper portfolio:', error);
            }
        }

        // Load performance metrics
        async function loadPaperMetrics() {
            try {
                const response = await fetch('/api/paper/metrics');
                const data = await response.json();

                if (data.status === 'success') {
                    const metrics = data.metrics;
                    document.getElementById('winRate').textContent = formatPercent(metrics.win_rate || 0, 1);
                    document.getElementById('totalTrades').textContent = formatNumber(metrics.total_trades || 0, 0);
                    document.getElementById('profitFactor').textContent = safeNumber(metrics.profit_factor, 0).toFixed(2);
                    document.getElementById('avgGain').textContent = formatPercent(metrics.avg_gain_pct || 0);
                    document.getElementById('avgLoss').textContent = formatPercent(metrics.avg_loss_pct || 0);
                    document.getElementById('sharpeRatio').textContent = safeNumber(metrics.sharpe_ratio, 0).toFixed(2);
                }
            } catch (error) {
                console.error('Error loading paper metrics:', error);
            }
        }

        // Load open positions
        async function loadPaperPositions() {
            try {
                const response = await fetch('/api/paper/positions');
                const data = await response.json();

                const container = document.getElementById('paperPositionsList');

                if (data.status === 'success' && data.positions.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead style="background: #2d3748;"><tr>';
                    html += '<th style="padding: 10px; text-align: left;">Symbol</th>';
                    html += '<th style="padding: 10px; text-align: right;">Entry MC</th>';
                    html += '<th style="padding: 10px; text-align: right;">Current MC</th>';
                    html += '<th style="padding: 10px; text-align: right;">P&L</th>';
                    html += '<th style="padding: 10px; text-align: right;">Size</th>';
                    html += '<th style="padding: 10px; text-align: right;">Remaining</th>';
                    html += '</tr></thead><tbody>';

                    data.positions.forEach(pos => {
                        const entryMarketCap = safeNumber(pos.entry_market_cap);
                        const currentMarketCap = safeNumber(pos.current_market_cap);
                        const pnlPct = safeNumber(pos.current_pnl_pct);
                        const sizeUsd = safeNumber(pos.quantity_usd);
                        const remainingPct = safeNumber(pos.remaining_pct);
                        const remainingUsd = safeNumber(pos.remaining_value_usd);
                        const pnlColor = pnlPct >= 0 ? '#48bb78' : '#f56565';
                        html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                        html += `<td style="padding: 10px;">${pos.symbol}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">${entryMarketCap ? formatCurrency(entryMarketCap, 0) : '‚Äî'}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">${currentMarketCap ? formatCurrency(currentMarketCap, 0) : '‚Äî'}</td>`;
                        html += `<td style="padding: 10px; text-align: right; color: ${pnlColor};">${formatPercent(pnlPct)}</td>`;
                        html += `<td style="padding: 10px; text-align: right;">${formatCurrency(sizeUsd)}</td>`;
                        const remainingDisplay = `${formatCurrency(remainingUsd)} (${formatNumber(remainingPct, 0)}%)`;
                        html += `<td style="padding: 10px; text-align: right;">${remainingDisplay}</td>`;
                        html += `</tr>`;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>No open positions</p></div>';
                }
            } catch (error) {
                console.error('Error loading paper positions:', error);
            }
        }

        // Track previous trades for flash detection
        let previousTradeIds = new Set();

        // Load trade history
        async function loadPaperTrades() {
            try {
                const response = await fetch('/api/paper/trades?per_page=20');
                const data = await response.json();

                const container = document.getElementById('paperTradesList');

                if (data.status === 'success' && data.trades.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    html += '<thead style="background: #2d3748;"><tr>';
                    html += '<th style="padding: 8px; text-align: left;">Symbol</th>';
                    html += '<th style="padding: 8px; text-align: right;">Entry MC</th>';
                    html += '<th style="padding: 8px; text-align: right;">Exit MC</th>';
                    html += '<th style="padding: 8px; text-align: right;">P&L</th>';
                    html += '<th style="padding: 8px; text-align: right;">P&L ($)</th>';
                    html += '<th style="padding: 8px; text-align: center;">Exit Type</th>';
                    html += '<th style="padding: 8px; text-align: right;">Hold Time</th>';
                    html += '</tr></thead><tbody>';

                    const newTradeIds = new Set();
                    data.trades.forEach(trade => {
                        const entryPrice = toFiniteNumber(trade.entry_price);
                        const exitPrice = toFiniteNumber(trade.exit_price);
                        const entryMarketCap = toFiniteNumber(trade.entry_market_cap);
                        let exitMarketCap = toFiniteNumber(trade.exit_market_cap);
                        const pnlPct = safeNumber(trade.pnl_pct);
                        const pnlUsd = safeNumber(trade.pnl_usd);
                        const pnlColor = pnlPct >= 0 ? '#48bb78' : '#f56565';
                        const exitType = (trade.exit_type || '').toString();
                        newTradeIds.add(trade.id);

                        if ((exitMarketCap === null || exitMarketCap <= 0) &&
                            entryMarketCap && entryMarketCap > 0 &&
                            entryPrice && entryPrice > 0 &&
                            exitPrice && exitPrice > 0) {
                            const priceRatio = exitPrice / entryPrice;
                            if (Number.isFinite(priceRatio) && priceRatio > 0) {
                                exitMarketCap = entryMarketCap * priceRatio;
                            }
                        }

                        const entryDisplay = entryMarketCap && entryMarketCap > 0
                            ? formatCurrency(entryMarketCap, 0)
                            : '‚Äî';
                        const exitDisplay = exitMarketCap && exitMarketCap > 0
                            ? formatCurrency(exitMarketCap, 0)
                            : '‚Äî';

                        let holdDisplay = '‚Äî';
                        const holdDays = toFiniteNumber(trade.hold_days);
                        if (holdDays !== null) {
                            const holdHours = holdDays * 24;
                            if (Number.isFinite(holdHours)) {
                                const decimals = holdHours >= 100 ? 0 : 1;
                                holdDisplay = `${getNumberFormatter(decimals).format(holdHours)}h`;
                            }
                        }

                        // Check if this is a new trade (not in previous load)
                        const isNewTrade = !previousTradeIds.has(trade.id);
                        let flashClass = '';
                        if (isNewTrade && trade.pnl_pct >= 0) {
                            flashClass = ' flash-profit';
                        } else if (isNewTrade && trade.pnl_pct < 0) {
                            flashClass = ' flash-loss';
                        }

                        // Determine badge class based on exit type
                        let badgeClass = 'exit-badge';
                        if (exitType.includes('stop_loss')) {
                            badgeClass += ' stop-loss';
                        } else if (exitType.includes('take_profit')) {
                            badgeClass += ' take-profit';
                        } else if (exitType === 'failed_exit') {
                            badgeClass += ' failed';
                        } else if (exitType === 'max_hold') {
                            badgeClass += ' expired';
                        }

                        html += `<tr class="${flashClass}" style="border-bottom: 1px solid #2d3748;">`;
                        html += `<td style="padding: 8px;">${trade.symbol}</td>`;
                        html += `<td style="padding: 8px; text-align: right;">${entryDisplay}</td>`;
                        html += `<td style="padding: 8px; text-align: right;">${exitDisplay}</td>`;
                        html += `<td style="padding: 8px; text-align: right; color: ${pnlColor};">${formatPercent(pnlPct)}</td>`;
                        html += `<td style="padding: 8px; text-align: right; color: ${pnlColor};">${formatCurrency(pnlUsd)}</td>`;
                        html += `<td style="padding: 8px; text-align: center;"><span class="${badgeClass}">${exitType.replace(/_/g, ' ')}</span></td>`;
                        html += `<td style="padding: 8px; text-align: right;">${holdDisplay}</td>`;
                        html += `</tr>`;
                    });

                    // Update previous trade IDs for next comparison
                    previousTradeIds = newTradeIds;

                    html += '</tbody></table>';
                    html += `<div style="margin-top: 10px; color: #a0aec0;">Showing ${data.trades.length} of ${data.count} trades</div>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>No trades yet</p></div>';
                }
            } catch (error) {
                console.error('Error loading paper trades:', error);
            }
        }

        // ==================== ANALYTICS FUNCTIONS ====================

        async function loadAnalyticsOverview() {
            try {
                const response = await fetch('/api/analytics/summary');
                const data = await response.json();

                if (!data.enabled) {
                    renderNarrative(null, 'analyticsDailySummary');
                    renderNarrative(null, 'analyticsWeeklySummary');
                    document.getElementById('analyticsReturnPct').textContent = '--';
                    document.getElementById('analyticsAbsPnl').textContent = '--';
                    document.getElementById('analyticsDrawdown').textContent = '--';
                    document.getElementById('analyticsTrades').textContent = '--';
                    document.getElementById('analyticsTokenFlows').innerHTML = '<div class="empty-state"><p>Analytics pipeline disabled.</p></div>';
                    document.getElementById('analyticsRecentTrades').innerHTML = '<div class="empty-state"><p>Analytics pipeline disabled.</p></div>';
                    document.getElementById('analyticsPeriodLabel').textContent = '';
                    updateAnalyticsChart([], 0);
                    return;
                }

                const performance = data.performance || {};
                const trading = data.trading || {};
                const period = data.period || {};

                document.getElementById('analyticsReturnPct').textContent = formatPercent(performance.return_pct || 0, 2);
                document.getElementById('analyticsAbsPnl').textContent = formatCurrency(performance.absolute_return_usd || 0);
                document.getElementById('analyticsDrawdown').textContent = formatPercent(performance.max_drawdown_pct || 0, 2);
                document.getElementById('analyticsTrades').textContent = `${formatNumber(trading.total_trades || 0, 0)} (${formatNumber(trading.buy_count || 0, 0)}/${formatNumber(trading.sell_count || 0, 0)})`;

                const periodStart = parseTimestamp(period.start);
                const periodEnd = parseTimestamp(period.end);
                if (periodStart && periodEnd) {
                    document.getElementById('analyticsPeriodLabel').textContent =
                        `Covering ${periodStart.toLocaleString('en-US')} ‚Üí ${periodEnd.toLocaleString('en-US')} (${period.days || data.period.requested_days || 0} days)`;
                } else {
                    document.getElementById('analyticsPeriodLabel').textContent = '';
                }

                renderAnalyticsTokenFlows(trading.flow_by_token_usd || {});
                renderAnalyticsTrades(trading.recent || []);
                updateAnalyticsChart((data.portfolio && data.portfolio.series) || [], period.days || data.period.requested_days || 0);

                const reports = data.reports || {};
                if (reports.daily) {
                    renderNarrative(reports.daily, 'analyticsDailySummary');
                } else {
                    renderNarrative(null, 'analyticsDailySummary');
                }
                if (reports.weekly) {
                    renderNarrative(reports.weekly, 'analyticsWeeklySummary');
                } else {
                    renderNarrative(null, 'analyticsWeeklySummary');
                }
            } catch (error) {
                console.error('Error loading analytics overview:', error);
            }
        }

        function updateAnalyticsChart(series, labelDays = 0) {
            const canvas = document.getElementById('analyticsPerformanceChart');
            if (!canvas || typeof Chart === 'undefined') {
                return;
            }

            if (!Array.isArray(series) || series.length === 0) {
                if (analyticsChart) {
                    analyticsChart.destroy();
                    analyticsChart = null;
                }
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const labels = [];
            const equityValues = [];
            const cashValues = [];

            series.forEach(point => {
                const ts = parseTimestamp(point.timestamp);
                labels.push(ts ? ts.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : point.timestamp);
                equityValues.push(safeNumber(point.total_value_usd));
                cashValues.push(safeNumber(point.cash_value_usd));
            });

            const ctx = canvas.getContext('2d');
            if (analyticsChart) {
                analyticsChart.data.labels = labels;
                analyticsChart.data.datasets[0].data = equityValues;
                analyticsChart.data.datasets[1].data = cashValues;
                analyticsChart.update();
            } else {
                analyticsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Total Value (USD)',
                                data: equityValues,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.15)',
                                tension: 0.2,
                                fill: true,
                            },
                            {
                                label: 'Cash Value (USD)',
                                data: cashValues,
                                borderColor: '#63b3ed',
                                backgroundColor: 'rgba(99, 179, 237, 0.1)',
                                tension: 0.2,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#a0aec0', maxRotation: 45, minRotation: 45 },
                                grid: { color: 'rgba(160, 174, 192, 0.15)' }
                            },
                            y: {
                                ticks: {
                                    color: '#a0aec0',
                                    callback: value => formatCurrency(value)
                                },
                                grid: { color: 'rgba(160, 174, 192, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        function renderAnalyticsTokenFlows(flowByToken) {
            const container = document.getElementById('analyticsTokenFlows');
            const entries = Object.entries(flowByToken || {}).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1])).slice(0, 5);

            if (!entries.length) {
                container.innerHTML = '<div class="empty-state"><p>No token flow data yet.</p></div>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
            html += '<thead style="background: #2d3748;"><tr>';
            html += '<th style="padding: 10px; text-align: left;">Token</th>';
            html += '<th style="padding: 10px; text-align: right;">Net Flow (USD)</th>';
            html += '</tr></thead><tbody>';

            entries.forEach(([token, amount]) => {
                const display = token.length > 10 ? `${token.slice(0, 4)}‚Ä¶${token.slice(-4)}` : token;
                const color = amount >= 0 ? '#48bb78' : '#f56565';
                html += `<tr style="border-bottom: 1px solid #2d3748;">
                    <td style="padding: 10px;">${display}</td>
                    <td style="padding: 10px; text-align: right; color: ${color};">${formatCurrency(amount)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderAnalyticsTrades(trades) {
            const container = document.getElementById('analyticsRecentTrades');
            if (!Array.isArray(trades) || trades.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No trades recorded during this period.</p></div>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
            html += '<thead style="background: #2d3748;"><tr>';
            html += '<th style="padding: 8px; text-align: left;">Time</th>';
            html += '<th style="padding: 8px; text-align: left;">Token</th>';
            html += '<th style="padding: 8px; text-align: center;">Direction</th>';
            html += '<th style="padding: 8px; text-align: right;">Œî USD</th>';
            html += '<th style="padding: 8px; text-align: right;">After</th>';
            html += '</tr></thead><tbody>';

            trades.slice(0, 8).forEach(trade => {
                const ts = parseTimestamp(trade.timestamp);
                const timeLabel = ts ? ts.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : trade.timestamp;
                const token = trade.token ? `${trade.token.slice(0, 4)}‚Ä¶${trade.token.slice(-4)}` : '‚Äî';
                const delta = safeNumber(trade.usd_delta, 0);
                const color = delta >= 0 ? '#48bb78' : '#f56565';
                html += `<tr style="border-bottom: 1px solid #2d3748;">
                    <td style="padding: 8px;">${timeLabel}</td>
                    <td style="padding: 8px;">${token}</td>
                    <td style="padding: 8px; text-align: center;">${trade.direction || '‚Äî'}</td>
                    <td style="padding: 8px; text-align: right; color: ${color};">${formatCurrency(delta)}</td>
                    <td style="padding: 8px; text-align: right;">${formatCurrency(trade.after_usd || 0)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderNarrative(report, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!report || !report.narrative) {
                container.innerHTML = '<div class="empty-state"><p>No summary generated yet.</p></div>';
                return;
            }

            const narrative = report.narrative;
            const generatedAt = parseTimestamp(report.generated_at);
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

            html += `<div>
                <div style="font-size: 1.2rem; font-weight: 600; color: #edf2f7;">${narrative.headline || 'Performance Update'}</div>
                <div style="color: #a0aec0; font-size: 0.9rem;">${generatedAt ? generatedAt.toLocaleString('en-US') : ''}</div>
            </div>`;

            if (narrative.summary) {
                html += `<p style="color: #e2e8f0;">${narrative.summary}</p>`;
            }

            if (Array.isArray(narrative.key_takeaways) && narrative.key_takeaways.length) {
                html += '<div><strong>Key Takeaways</strong><ul>';
                narrative.key_takeaways.forEach(item => {
                    html += `<li style="margin-left: 20px; color: #e2e8f0;">${item}</li>`;
                });
                html += '</ul></div>';
            }

            if (Array.isArray(narrative.risk_notes) && narrative.risk_notes.length) {
                html += '<div><strong>Risks</strong><ul>';
                narrative.risk_notes.forEach(item => {
                    html += `<li style="margin-left: 20px; color: #f6ad55;">${item}</li>`;
                });
                html += '</ul></div>';
            }

            if (Array.isArray(narrative.next_actions) && narrative.next_actions.length) {
                html += '<div><strong>Next Actions</strong><ul>';
                narrative.next_actions.forEach(item => {
                    html += `<li style="margin-left: 20px; color: #63b3ed;">${item}</li>`;
                });
                html += '</ul></div>';
            }

            html += `<div style="color: #718096; font-size: 0.85rem;">
                Tone: ${narrative.tone || 'neutral'} ¬∑ Model: ${(report.model && report.model.name) || 'N/A'}
            </div>`;

            html += '</div>';
            container.innerHTML = html;
        }

        async function triggerAnalyticsReport(type) {
            try {
                const response = await fetch('/api/analytics/reports/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to trigger report:', errorData);
                    return;
                }
                await loadAnalyticsOverview();
            } catch (error) {
                console.error('Error triggering analytics report:', error);
            }
        }
    </script>
</body>
</html>